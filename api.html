<!DOCTYPE html>
<html lang="id">
<head>
  <!-- 1. SATPAM KEAMANAN -->
  <script src="auth-guard.js"></script>

  <link rel="manifest" href="manifest.webmanifest">
  <!-- 2. THEME COLOR DIPERBARUI -->
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>OBSCURA - Pengaturan</title>
  <link href="https://fonts.googleapis.com/css2?family=Cardo:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Cardo', serif;
      background: radial-gradient(ellipse at center, #111 0%, #000 100%);
      color: #e0e0e0;
    }
    section {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    input, button {
      width: 100%;
      box-sizing: border-box;
      font-family: 'Cardo', serif;
      padding: 10px;
      margin-top: 8px;
      background: #111;
      border: 1px solid #444;
      color: #e0e0e0;
      border-radius: 5px;
      display: block;
    }
    button {
        cursor: pointer;
    }
    button:hover {
        background-color: #222;
    }
    #popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 20px 30px;
      border-radius: 12px;
      font-family: 'Cardo', serif;
      font-size: 18px;
      color: #e0e0e0;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(4px);
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
      text-align: center;
    }
    #popup.show {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <section>
    <h2>ID Anda</h2>
    <input type="text" id="uniqueCode" maxlength="6" placeholder="6 digit angka">
    <div id="codeStatus">Masukkan 6 digit angka untuk ID Anda.</div>
    <button id="resetCodeBtn" style="display:none; margin-top: 10px;">Ganti ID</button>
  </section>

  <section>
    <h2>Partner</h2>
    <input type="text" id="accompliceCode" placeholder="Masukkan ID partner">
    <button id="linkBtn">Kirim Permintaan Koneksi</button>
    <button id="disconnectBtn" style="margin-top: 10px; background-color: #521818;">Putuskan Sambungan</button>
  </section>

  <section>
  <h2>Custom Thump</h2>
  <input type="text" id="customPresetInput" placeholder="Pisahkan preset dengan koma (contoh: Merah, Bulat, 12)">
  <div style="margin-top: 10px; display: flex; gap: 10px;">
    <button id="savePresetBtn">Simpan Preset</button>
    <button id="clearPresetBtn" style="background-color: #d32f2f; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">Hapus Preset</button>
  </div>
</section>


  <section>
    <a href="main.html" style="text-decoration: none;"><button type="button">Kembali ke Menu</button></a>
    <button id="clearDataBtn" style="margin-top: 12px; background-color: #400; color: #f44336;">Hapus Semua Jejak</button>
  </section>

  <div id="popup"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDagbp2KWMuueh-ZmFZQ-nSAnRcummUgkM",
      authDomain: "obscurabyheri.firebaseapp.com",
      databaseURL: "https://obscurabyheri-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "obscurabyheri",
      storageBucket: "obscurabyheri.appspot.com",
      messagingSenderId: "866868400960",
      appId: "1:866868400960:web:440e1b4979a1c0cf8a20a5"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const codeInput = document.getElementById('uniqueCode');
    const status = document.getElementById('codeStatus');
    const resetBtn = document.getElementById('resetCodeBtn');
    const accompliceInput = document.getElementById('accompliceCode');
    const linkBtn = document.getElementById('linkBtn');
    const clearDataBtn = document.getElementById('clearDataBtn');
    const popup = document.getElementById('popup');
    const disconnectBtn = document.getElementById('disconnectBtn');
    let knownPartnerCode = localStorage.getItem('accompliceCode') || null;

    function showPopup(text, duration = 2500) {
      popup.textContent = text;
      popup.classList.add("show");
      setTimeout(() => popup.classList.remove("show"), duration);
    }
    
    function initializePage() {
        const myCode = localStorage.getItem('myCode');
        disconnectBtn.style.display = 'none';

        if (myCode) {
            codeInput.value = myCode;
            codeInput.disabled = true;
            status.textContent = "ID ini sudah digunakan oleh Anda.";
            status.style.color = "#4caf50";
            resetBtn.style.display = 'block';

            const connRef = ref(db, `connections/${myCode}/partner`);
            onValue(connRef, (snap) => {
                const newPartnerCode = snap.val();
                
                if (newPartnerCode && newPartnerCode !== knownPartnerCode) {
                    showPopup(`Anda kini tersambung dengan: ${newPartnerCode}`);
                }
                
                if (newPartnerCode) {
                    accompliceInput.value = newPartnerCode;
                    localStorage.setItem('accompliceCode', newPartnerCode);
                    disconnectBtn.style.display = 'block';
                } else {
                    accompliceInput.value = '';
                    localStorage.removeItem('accompliceCode');
                    disconnectBtn.style.display = 'none';
                }
                
                knownPartnerCode = newPartnerCode;
            });
        } else {
            codeInput.addEventListener('input', handleNewCodeInput);
        }
    }
    
    linkBtn.addEventListener('click', async () => {
      const myCode = localStorage.getItem('myCode');
      const accompliceCode = accompliceInput.value.trim();

      if (!myCode) { showPopup('Anda harus mengatur ID Anda terlebih dahulu!'); return; }
      if (!/^\d{6}$/.test(accompliceCode)) { showPopup('ID partner harus 6 digit angka!'); return; }
      if (myCode === accompliceCode) { showPopup('Anda tidak bisa terhubung dengan diri sendiri.'); return; }
      
      const accompliceUserRef = ref(db, `users/${accompliceCode}`);
      const snap = await get(accompliceUserRef);
      if (!snap.exists()) { showPopup(`ID partner ${accompliceCode} tidak ditemukan.`); return; }

      const targetConnRef = ref(db, `connections/${accompliceCode}`);
      const targetConnSnap = await get(targetConnRef);
      if (targetConnSnap.exists()) {
          showPopup(`User ${accompliceCode} sedang sibuk atau sudah terhubung.`);
          return;
      }
      
      await set(ref(db, `connections/${accompliceCode}/requestFrom`), myCode);
      
      showPopup(`Permintaan koneksi terkirim ke ${accompliceCode}.`);
    });

    disconnectBtn.addEventListener('click', async () => {
        const myCode = localStorage.getItem('myCode');
        const accompliceCode = localStorage.getItem('accompliceCode');
        if (!myCode || !accompliceCode) { showPopup("Anda sedang tidak terhubung dengan siapapun."); return; }
        if (confirm(`Anda yakin ingin memutuskan sambungan dengan ${accompliceCode}?`)) {
            try {
                await remove(ref(db, `connections/${myCode}`));
                await remove(ref(db, `connections/${accompliceCode}`));
                localStorage.removeItem('accompliceCode');
                showPopup("Sambungan telah diputuskan.");
                accompliceInput.value = '';
                disconnectBtn.style.display = 'none';
            } catch (err) {
                console.error("Gagal memutuskan koneksi:", err);
                showPopup("Terjadi error saat mencoba memutuskan koneksi.");
            }
        }
    });

    async function handleNewCodeInput(e) {
        const code = e.target.value.trim();
        if (!/^\d{6}$/.test(code)) { status.textContent = "ID harus terdiri dari 6 digit angka."; status.style.color = "#f44336"; return; }
        const userRef = ref(db, `users/${code}`);
        const snap = await get(userRef);
        if (snap.exists()) { status.textContent = "ID ini sudah digunakan oleh orang lain."; status.style.color = "#f44336"; } else {
            await set(userRef, { createdAt: Date.now() });
            localStorage.setItem('myCode', code);
            status.textContent = "ID tersedia dan telah disimpan."; status.style.color = "#4caf50";
            codeInput.disabled = true; resetBtn.style.display = 'block';
            codeInput.removeEventListener('input', handleNewCodeInput);
        }
    }

    resetBtn.addEventListener('click', async () => { if (confirm("Anda yakin ingin mengganti ID? Ini akan memutuskan koneksi yang ada.")) { await clearAllData(); location.reload(); } });
    
    clearDataBtn.onclick = async () => {
        if (confirm("TINDAKAN PERMANEN! Ini akan menghapus ID Anda, koneksi, dan semua data dari cloud dan perangkat ini. Lanjutkan?")) {
            await clearAllData();
            showPopup("Semua jejak telah dihapus.");
            setTimeout(() => {
                codeInput.disabled = false; codeInput.value = ''; accompliceInput.value = '';
                status.textContent = 'Masukkan 6 digit angka untuk ID Anda.'; status.style.color = '#e0e0e0';
                resetBtn.style.display = 'none'; codeInput.addEventListener('input', handleNewCodeInput);
            }, 2000);
        }
    };

    async function clearAllData() {
        const myCode = localStorage.getItem('myCode');
        const accompliceCode = localStorage.getItem('accompliceCode');
        try {
            if (myCode) {
                if (accompliceCode) { await remove(ref(db, `connections/${accompliceCode}`)); }
                await remove(ref(db, `users/${myCode}`));
                await remove(ref(db, `connections/${myCode}`));
                await remove(ref(db, `data/${myCode}`));
                await remove(ref(db, `status/${myCode}`));
            }
        } catch (err) { console.error("Gagal menghapus data Firebase:", err); showPopup("Error saat menghapus data di cloud.");
        } finally {
            // PERBAIKAN UTAMA: Hanya hapus data sesi, bukan semua data.
            // Ini akan menjaga 'obscura_authorized' tetap aman.
            localStorage.removeItem('myCode');
            localStorage.removeItem('accompliceCode');
        }
    }

  const savePresetBtn = document.getElementById('savePresetBtn');
  const clearPresetBtn = document.getElementById('clearPresetBtn');
  const customPresetInput = document.getElementById('customPresetInput');

  savePresetBtn.addEventListener('click', () => {
    const input = customPresetInput.value.trim();
    if (!input) return;

    const presets = input.split(',').map(x => x.trim()).filter(Boolean);
    localStorage.setItem('customPresets', JSON.stringify(presets));
    alert('Preset disimpan!');
  });

  clearPresetBtn.addEventListener('click', () => {
    localStorage.removeItem('customPresets');
    customPresetInput.value = '';
    alert('Preset dihapus!');
  });

    
    initializePage();
  </script>
</body>
</html>
