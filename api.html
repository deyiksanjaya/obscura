<!DOCTYPE html>
<html lang="id">
<head>
  <script src="auth-guard.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Obscura - Pengaturan</title>
  <link href="https://fonts.googleapis.com/css2?family=Cardo:wght@400,700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
        height: 100%;
        background: radial-gradient(ellipse at center, #111 0%, #000 100%);
        font-family: 'Cardo', serif;
        color: #e0e0e0;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 20px;
        opacity: 0;
        animation: fadeIn 1s forwards;
    }
    @keyframes fadeIn { to { opacity: 1; } }

    .container {
        width: 100%;
        max-width: 400px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 30px 35px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(5px);
    }

    h1 {
        font-size: 24px;
        margin-bottom: 25px;
        font-weight: 700;
        letter-spacing: 1px;
    }

    .input-group {
        margin-bottom: 20px;
        text-align: left;
    }

    label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        color: #aaa;
    }

    input {
        width: 100%;
        padding: 12px 15px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: #e0e0e0;
        font-family: 'Cardo', serif;
        font-size: 16px;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    input:focus {
        outline: none;
        border-color: #28a745;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
    }

    button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        background-color: #28a745;
        color: white;
        font-size: 16px;
        font-family: 'Cardo', serif;
        font-weight: 700;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
        margin-bottom: 15px;
    }

    button:hover {
        background-color: #218838;
        transform: scale(1.02);
    }

    #backButton {
        background-color: #6c757d;
    }

    #backButton:hover {
        background-color: #5a6268;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Pengaturan Identitas</h1>
    <div class="input-group">
      <label for="nameInput">Nama Anda</label>
      <input type="text" id="nameInput" placeholder="Kosongkan jika tidak diubah">
    </div>
    <div class="input-group">
      <label for="idInput">ID Unik Anda</label>
      <input type="text" id="idInput" placeholder="Kosongkan jika tidak diubah">
    </div>
    <button id="saveIdentity">Simpan Identitas</button>
    <button id="backButton">Kembali ke Menu</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDagbp2KWMuueh-ZmFZQ-nSAnRcummUgkM",
      authDomain: "obscurabyheri.firebaseapp.com",
      databaseURL: "https://obscurabyheri-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "obscurabyheri",
      storageBucket: "obscurabyheri.appspot.com",
      messagingSenderId: "866868400960",
      appId: "1:866868400960:web:440e1b4979a1c0cf8a20a5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const nameInput = document.getElementById('nameInput');
    const idInput = document.getElementById('idInput');
    const saveButton = document.getElementById('saveIdentity');
    const backButton = document.getElementById('backButton');

    // Tampilkan data yang ada sebagai placeholder
    document.addEventListener('DOMContentLoaded', () => {
        const currentName = localStorage.getItem('myName');
        const currentId = localStorage.getItem('myCode');
        if (currentName) {
            nameInput.placeholder = `Nama saat ini: ${currentName}`;
        }
        if (currentId) {
            idInput.placeholder = `ID saat ini: ${currentId}`;
        }
    });
    
    backButton.addEventListener('click', () => {
      window.location.href = 'main.html';
    });

    saveButton.addEventListener('click', async () => {
        const newName = nameInput.value.trim();
        const newId = idInput.value.trim();
        
        const currentName = localStorage.getItem('myName');
        const currentId = localStorage.getItem('myCode');

        if (!newName && !newId) {
            alert("Silakan isi setidaknya satu kolom untuk memperbarui identitas Anda.");
            return;
        }

        let changesMade = false;
        
        try {
            // --- Logika untuk memperbarui ID ---
            if (newId && newId !== currentId) {
                const newIdRef = ref(db, `users/${newId}`);
                const newIdSnap = await get(newIdRef);

                if (newIdSnap.exists()) {
                    alert("ID ini sudah digunakan oleh orang lain. Silakan pilih ID yang lain.");
                    return;
                }

                // Jika ada ID lama, pindahkan data. Jika tidak, buat baru.
                if (currentId) {
                    const oldIdRef = ref(db, `users/${currentId}`);
                    const oldDataSnap = await get(oldIdRef);
                    if (oldDataSnap.exists()) {
                        await set(newIdRef, oldDataSnap.val()); // Salin data ke ID baru
                        await remove(oldIdRef); // Hapus data dari ID lama
                    }
                }
                
                // Perbarui ID di localStorage
                localStorage.setItem('myCode', newId);
                changesMade = true;
            }

            // Dapatkan ID yang akan digunakan untuk update nama (bisa ID baru atau ID lama)
            const finalId = localStorage.getItem('myCode');

            // --- Logika untuk memperbarui Nama ---
            if (newName && newName !== currentName) {
                if (!finalId) {
                    alert("Anda harus mengatur ID terlebih dahulu sebelum bisa menyimpan nama.");
                    return;
                }
                const nameRef = ref(db, `users/${finalId}/name`);
                await set(nameRef, newName);
                localStorage.setItem('myName', newName);
                changesMade = true;
            }

            if (changesMade) {
                alert("Identitas berhasil diperbarui!");
                // Reload halaman untuk membersihkan input dan memperbarui placeholder
                window.location.reload(); 
            } else {
                alert("Tidak ada perubahan yang dilakukan. Nilai yang Anda masukkan sama dengan yang sudah tersimpan.");
            }

        } catch (error) {
            console.error("Gagal menyimpan identitas:", error);
            alert("Terjadi kesalahan saat menyimpan identitas. Silakan coba lagi.");
        }
    });
  </script>
</body>
</html>
