<!DOCTYPE html>
<html lang="id">
<head>
  <script src="auth-guard.js"></script>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>OBSCURA - Pengaturan</title>
  <link href="https://fonts.googleapis.com/css2?family=Cardo:wght@700&display=swap" rel="stylesheet">
  <style>
    body{margin:0;padding:0;font-family:'Cardo',serif;background:radial-gradient(ellipse at center,#111 0%,#000 100%);color:#e0e0e0}
    section{padding:20px;border-bottom:1px solid rgba(255,255,255,.1)}
    input,button{width:100%;box-sizing:border-box;font-family:'Cardo',serif;padding:12px;margin-top:8px;background:#111;border:1px solid #444;color:#e0e0e0;border-radius:5px;display:block}
    input:disabled{background-color:#222;cursor:not-allowed}
    button{cursor:pointer}
    button:hover{background-color:#222}
    #popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05);padding:20px 30px;border-radius:12px;font-family:'Cardo',serif;font-size:18px;color:#e0e0e0;box-shadow:0 0 20px rgba(255,255,255,.05);backdrop-filter:blur(4px);z-index:999;opacity:0;pointer-events:none;transition:opacity .5s ease;text-align:center}
    #popup.show{opacity:1;pointer-events:auto}
    .status-text{font-size:.9em;color:#888;margin-top:4px;min-height:1em}
  </style>
</head>
<body>
  <section>
    <h2>Identitas Anda</h2>
    <input type="text" id="userName" placeholder="Masukkan nama Anda">
    <div id="nameStatus" class="status-text"></div>
    <input type="text" id="uniqueCode" maxlength="6" placeholder="6 digit angka" disabled>
    <div id="codeStatus" class="status-text"></div>
    <button id="resetCodeBtn" style="display:none; margin-top: 10px;">Ganti Identitas</button>
  </section>

  <section>
    <h2>Partner</h2>
    <input type="text" id="accompliceCode" placeholder="Masukkan ID partner">
    <button id="linkBtn">Kirim Permintaan Koneksi</button>
    <div id="partnerStatus" class="status-text"></div>
    <button id="cancelRequestBtn" style="display:none; margin-top: 10px; background-color: #555;">Batalkan Permintaan</button>
    <button id="disconnectBtn" style="display:none; margin-top: 10px; background-color: #521818;">Putuskan Sambungan</button>
  </section>

  <section>
    <h2>Custom Thump</h2>
    <input type="text" id="customPresetInput" placeholder="Pisahkan preset dengan koma">
    <div style="margin-top: 10px; display: flex; gap: 10px;">
      <button id="savePresetBtn">Simpan Preset</button>
      <button id="clearPresetBtn" style="background-color: #d32f2f;">Hapus Preset</button>
    </div>
  </section>

  <section>
    <a href="main.html" style="text-decoration: none;"><button type="button">Kembali ke Menu</button></a>
    <button id="clearDataBtn" style="margin-top: 12px; background-color: #400; color: #f44336;">Hapus Semua Jejak</button>
  </section>

  <div id="popup"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, set, remove, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDagbp2KWMuueh-ZmFZQ-nSAnRcummUgkM",
      authDomain: "obscurabyheri.firebaseapp.com",
      databaseURL: "https://obscurabyheri-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "obscurabyheri",
      storageBucket: "obscurabyheri.appspot.com",
      messagingSenderId: "866868400960",
      appId: "1:866868400960:web:440e1b4979a1c0cf8a20a5"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const userNameInput = document.getElementById('userName');
    const nameStatus = document.getElementById('nameStatus');
    const codeInput = document.getElementById('uniqueCode');
    const codeStatus = document.getElementById('codeStatus');
    const resetBtn = document.getElementById('resetCodeBtn');
    const accompliceInput = document.getElementById('accompliceCode');
    const linkBtn = document.getElementById('linkBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const popup = document.getElementById('popup');
    const clearDataBtn = document.getElementById('clearDataBtn');
    const partnerStatus = document.getElementById('partnerStatus');
    const cancelRequestBtn = document.getElementById('cancelRequestBtn');
    
    let isEditMode = false;

    function showPopup(text, duration = 2500) {
      popup.textContent = text;
      popup.classList.add("show");
      setTimeout(() => popup.classList.remove("show"), duration);
    }
    
    async function initializePage() {
      const myCode = localStorage.getItem('myCode');
      const myName = localStorage.getItem('myName');
      
      disconnectBtn.style.display = 'none';

      if (myCode && myName) {
        setupExistingUser(myCode, myName);
        listenForPartner(myCode);
        listenForSentRequest(myCode);
      } else if (myCode && !myName) {
        setupOldUserNeedsName(myCode);
      } else {
        setupNewUser();
      }
    }

    function setupExistingUser(myCode, myName) {
        userNameInput.value = myName;
        userNameInput.disabled = true;
        codeInput.value = myCode;
        codeInput.disabled = true;
        nameStatus.textContent = `Nama Anda: ${myName}`;
        codeStatus.textContent = `ID Anda: ${myCode}`;
        resetBtn.style.display = 'block';
    }

    function setupOldUserNeedsName(myCode) {
        showPopup("Update: Silakan masukkan nama Anda untuk melanjutkan.");
        codeInput.value = myCode;
        codeInput.disabled = true;
        userNameInput.disabled = false;
        nameStatus.textContent = "Masukkan nama Anda, lalu tekan Enter.";
        
        userNameInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                const newName = userNameInput.value.trim();
                if (newName) {
                    await update(ref(db, `users/${myCode}`), { name: newName });
                    localStorage.setItem('myName', newName);
                    showPopup("Nama berhasil diperbarui!");
                    setTimeout(() => location.reload(), 1500);
                }
            }
        });
    }
    
    function setupNewUser() {
        nameStatus.textContent = "1. Masukkan nama, lalu tekan Enter.";
        userNameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const newName = userNameInput.value.trim();
                if (newName) {
                    localStorage.setItem('myName', newName);
                    userNameInput.disabled = true;
                    codeInput.disabled = false;
                    nameStatus.textContent = `Nama disimpan: ${newName}`;
                    codeStatus.textContent = "2. Sekarang masukkan 6 digit ID Anda.";
                    codeInput.focus();
                }
            }
        });
        codeInput.addEventListener('input', handleNewCodeInput);
    }

    async function handleNewCodeInput(e) {
        const code = e.target.value.trim();
        if (!/^\d{6}$/.test(code)) {
            codeStatus.textContent = "ID harus terdiri dari 6 digit angka.";
            return;
        }
        const userRef = ref(db, `users/${code}`);
        const snap = await get(userRef);
        if (snap.exists()) {
            codeStatus.textContent = "ID ini sudah digunakan. Coba yang lain.";
        } else {
            const myName = localStorage.getItem('myName');
            await set(userRef, { name: myName, createdAt: Date.now() });
            localStorage.setItem('myCode', code);
            codeStatus.textContent = "ID berhasil disimpan!";
            codeInput.disabled = true;
            resetBtn.style.display = 'block';
            codeInput.removeEventListener('input', handleNewCodeInput);
        }
    }

    function listenForSentRequest(myCode) {
        const requestToRef = ref(db, `connections/${myCode}/requestTo`);
        onValue(requestToRef, async (snap) => {
            const pendingPartnerId = snap.val();
            if (pendingPartnerId) {
                const partnerUserRef = ref(db, `users/${pendingPartnerId}`);
                const partnerSnap = await get(partnerUserRef);
                const partnerName = partnerSnap.exists() ? partnerSnap.val().name : pendingPartnerId;

                accompliceInput.disabled = true;
                accompliceInput.value = '';
                linkBtn.style.display = 'none';
                cancelRequestBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
                partnerStatus.textContent = `Menunggu persetujuan dari ${partnerName}...`;
            } else {
                if (!localStorage.getItem('accompliceCode')) {
                    accompliceInput.disabled = false;
                    linkBtn.style.display = 'block';
                    cancelRequestBtn.style.display = 'none';
                    partnerStatus.textContent = '';
                }
            }
        });
    }

    function listenForPartner(myCode) {
        const connRef = ref(db, `connections/${myCode}/partner`);
        onValue(connRef, async (snap) => {
            const partnerCode = snap.val();
            if (partnerCode) {
                const partnerUserRef = ref(db, `users/${partnerCode}`);
                const partnerSnap = await get(partnerUserRef);
                const partnerName = partnerSnap.exists() ? partnerSnap.val().name : "Partner";
                
                showPopup(`Anda kini tersambung dengan: ${partnerName} (${partnerCode})`);
                accompliceInput.value = `${partnerName} (${partnerCode})`;
                accompliceInput.disabled = true;
                localStorage.setItem('accompliceCode', partnerCode);
                
                linkBtn.style.display = 'none';
                cancelRequestBtn.style.display = 'none';
                partnerStatus.textContent = '';
                disconnectBtn.style.display = 'block';

            } else {
                if(!isEditMode) accompliceInput.value = '';
                accompliceInput.disabled = false;
                localStorage.removeItem('accompliceCode');
                disconnectBtn.style.display = 'none';
            }
        });
    }

    linkBtn.addEventListener('click', async () => {
        const myCode = localStorage.getItem('myCode');
        const accompliceCode = accompliceInput.value.trim();
        if (!myCode) { showPopup('Anda harus mengatur identitas Anda terlebih dahulu!'); return; }
        if (!accompliceCode) { showPopup('Masukkan ID partner.'); return; }
        if (accompliceCode === myCode) { showPopup('Anda tidak bisa terhubung dengan diri sendiri.'); return; }
        
        const accompliceUserRef = ref(db, `users/${accompliceCode}`);
        const snap = await get(accompliceUserRef);
        if (!snap.exists()) { showPopup(`ID partner ${accompliceCode} tidak ditemukan.`); return; }

        await set(ref(db, `connections/${accompliceCode}/requestFrom`), myCode);
        await set(ref(db, `connections/${myCode}/requestTo`), accompliceCode);
        showPopup(`Permintaan koneksi terkirim.`);
    });

    cancelRequestBtn.addEventListener('click', async () => {
        const myCode = localStorage.getItem('myCode');
        const requestToRef = ref(db, `connections/${myCode}/requestTo`);
        const snap = await get(requestToRef);
        const pendingPartnerId = snap.val();

        if (myCode && pendingPartnerId) {
            await remove(ref(db, `connections/${pendingPartnerId}/requestFrom`));
            await remove(requestToRef);
            showPopup("Permintaan dibatalkan.");
        }
    });

    disconnectBtn.addEventListener('click', async () => {
        const myCode = localStorage.getItem('myCode');
        const accompliceCode = localStorage.getItem('accompliceCode');
        if (!myCode || !accompliceCode) return;

        if (confirm(`Anda yakin ingin memutuskan sambungan dengan partner?`)) {
            await remove(ref(db, `connections/${myCode}/partner`));
            await remove(ref(db, `connections/${accompliceCode}/partner`));
            showPopup("Koneksi berhasil diputuskan.");
        }
    });
    
    resetBtn.addEventListener('click', async () => { 
        if (!isEditMode) {
            if (confirm("Anda yakin ingin mengubah identitas? Ini akan memutuskan koneksi yang ada jika Anda mengubah ID.")) {
                const currentName = localStorage.getItem('myName');
                const currentId = localStorage.getItem('myCode');
                userNameInput.disabled = false;
                codeInput.disabled = false;
                userNameInput.value = '';
                codeInput.value = '';
                userNameInput.placeholder = `Nama saat ini: ${currentName}`;
                codeInput.placeholder = `ID saat ini: ${currentId}`;
                resetBtn.textContent = 'Simpan Perubahan';
                resetBtn.style.backgroundColor = '#28a745';
                isEditMode = true;
            }
        } else {
            const newName = userNameInput.value.trim();
            const newId = codeInput.value.trim();
            if (!newName && !newId) {
                showPopup("Tidak ada perubahan. Setidaknya isi satu kolom.");
                return;
            }
            try {
                let changesMade = false;
                const currentName = localStorage.getItem('myName');
                const currentId = localStorage.getItem('myCode');

                if (newId && newId !== currentId) {
                    if (!/^\d{6}$/.test(newId)) { showPopup("ID baru harus 6 digit angka."); return; }
                    const newIdRef = ref(db, `users/${newId}`);
                    const snap = await get(newIdRef);
                    if (snap.exists()) { showPopup("ID baru sudah digunakan. Coba yang lain."); return; }
                    const oldDataSnap = await get(ref(db, `users/${currentId}`));
                    if (oldDataSnap.exists()) {
                        await set(newIdRef, oldDataSnap.val());
                        await remove(ref(db, `users/${currentId}`));
                    }
                    localStorage.setItem('myCode', newId);
                    changesMade = true;
                }
                const finalId = localStorage.getItem('myCode');
                if (newName && newName !== currentName) {
                    await update(ref(db, `users/${finalId}`), { name: newName });
                    localStorage.setItem('myName', newName);
                    changesMade = true;
                }
                if (changesMade) {
                    showPopup("Identitas berhasil diperbarui!");
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showPopup("Tidak ada data yang diubah.");
                    location.reload();
                }
            } catch (error) {
                console.error("Gagal menyimpan perubahan:", error);
                showPopup("Terjadi kesalahan saat menyimpan.");
            } finally {
                isEditMode = false;
            }
        }
    });
    
    clearDataBtn.onclick = async () => {
        if (confirm("TINDAKAN PERMANEN! Ini akan menghapus semua jejak Anda. Lanjutkan?")) {
            const myCode = localStorage.getItem('myCode');
            const accompliceCode = localStorage.getItem('accompliceCode');
            try {
                if (myCode) {
                    if (accompliceCode) { await remove(ref(db, `connections/${accompliceCode}`)); }
                    await remove(ref(db, `users/${myCode}`));
                    await remove(ref(db, `connections/${myCode}`));
                }
            } finally {
                localStorage.removeItem('myCode');
                localStorage.removeItem('myName');
                localStorage.removeItem('accompliceCode');
                localStorage.removeItem('customPresets');
            }
            showPopup("Semua jejak telah dihapus.");
            setTimeout(() => location.reload(), 1500);
        }
    };

    const savePresetBtn = document.getElementById('savePresetBtn');
    const clearPresetBtn = document.getElementById('clearPresetBtn');
    const customPresetInput = document.getElementById('customPresetInput');
    savePresetBtn.addEventListener('click', () => {
        const presets = customPresetInput.value.trim().split(',').map(p => p.trim()).filter(Boolean);
        if(presets.length > 0) {
            localStorage.setItem('customPresets', JSON.stringify(presets));
            showPopup('Preset disimpan!');
        }
    });
    clearPresetBtn.addEventListener('click', () => {
        localStorage.removeItem('customPresets');
        customPresetInput.value = '';
        showPopup('Preset dihapus!');
    });
    customPresetInput.value = JSON.parse(localStorage.getItem('customPresets') || '[]').join(', ');
    
    initializePage();
  </script>
</body>
</html>
