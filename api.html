<!DOCTYPE html>
<html lang="id">
<head>
  <script src="auth-guard.js"></script>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>OBSCURA - Pengaturan</title>
  <link href="https://fonts.googleapis.com/css2?family=Cardo:wght@700&display=swap" rel="stylesheet">
  <style>
    body{margin:0;padding:0;font-family:'Cardo',serif;background:radial-gradient(ellipse at center,#111 0%,#000 100%);color:#e0e0e0}
    section{padding:20px;border-bottom:1px solid rgba(255,255,255,.1)}
    input,button{width:100%;box-sizing:border-box;font-family:'Cardo',serif;padding:12px;margin-top:8px;background:#111;border:1px solid #444;color:#e0e0e0;border-radius:5px;display:block}
    input:disabled{background-color:#222;cursor:not-allowed}
    button{cursor:pointer}
    button:hover{background-color:#222}
    #popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05);padding:20px 30px;border-radius:12px;font-family:'Cardo',serif;font-size:18px;color:#e0e0e0;box-shadow:0 0 20px rgba(255,255,255,.05);backdrop-filter:blur(4px);z-index:999;opacity:0;pointer-events:none;transition:opacity .5s ease;text-align:center}
    #popup.show{opacity:1;pointer-events:auto}
    .status-text{font-size:.9em;color:#888;margin-top:4px;min-height:1em}
  </style>
</head>
<body>
  <section>
    <h2>Identitas Anda</h2>
    <input type="text" id="userName" placeholder="Masukkan nama Anda">
    <div id="nameStatus" class="status-text"></div>
    <input type="text" id="uniqueCode" maxlength="6" placeholder="6 digit angka" disabled>
    <div id="codeStatus" class="status-text"></div>
    <button id="resetCodeBtn" style="display:none; margin-top: 10px;">Ganti Identitas</button>
  </section>

  <section>
    <h2>Partner</h2>
    <input type="text" id="accompliceCode" placeholder="Masukkan ID partner">
    <button id="linkBtn">Kirim Permintaan Koneksi</button>
    <button id="disconnectBtn" style="margin-top: 10px; background-color: #521818;">Putuskan Sambungan</button>
  </section>

  <section>
    <h2>Custom Thump</h2>
    <input type="text" id="customPresetInput" placeholder="Pisahkan preset dengan koma">
    <div style="margin-top: 10px; display: flex; gap: 10px;">
      <button id="savePresetBtn">Simpan Preset</button>
      <button id="clearPresetBtn" style="background-color: #d32f2f;">Hapus Preset</button>
    </div>
  </section>

  <section>
    <a href="main.html" style="text-decoration: none;"><button type="button">Kembali ke Menu</button></a>
    <button id="clearDataBtn" style="margin-top: 12px; background-color: #400; color: #f44336;">Hapus Semua Jejak</button>
  </section>

  <div id="popup"></div>

  <script type="module">
    // PERBAIKAN: Menambahkan 'update' untuk fail-safe
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, set, remove, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDagbp2KWMuueh-ZmFZQ-nSAnRcummUgkM",
      authDomain: "obscurabyheri.firebaseapp.com",
      databaseURL: "https://obscurabyheri-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "obscurabyheri",
      storageBucket: "obscurabyheri.appspot.com",
      messagingSenderId: "866868400960",
      appId: "1:866868400960:web:440e1b4979a1c0cf8a20a5"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Variabel elemen DOM
    const userNameInput = document.getElementById('userName');
    const nameStatus = document.getElementById('nameStatus');
    const codeInput = document.getElementById('uniqueCode');
    const codeStatus = document.getElementById('codeStatus');
    const resetBtn = document.getElementById('resetCodeBtn');
    const accompliceInput = document.getElementById('accompliceCode');
    const linkBtn = document.getElementById('linkBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const popup = document.getElementById('popup');
    const clearDataBtn = document.getElementById('clearDataBtn');
    
    // --- FUNGSI UTAMA ---

    function showPopup(text, duration = 2500) {
      popup.textContent = text;
      popup.classList.add("show");
      setTimeout(() => popup.classList.remove("show"), duration);
    }
    
    async function initializePage() {
      const myCode = localStorage.getItem('myCode');
      const myName = localStorage.getItem('myName');
      
      disconnectBtn.style.display = 'none';

      if (myCode && myName) { // Pengguna lama yang sudah lengkap
        setupExistingUser(myCode, myName);
        listenForPartner(myCode);
      } else if (myCode && !myName) { // FAIL-SAFE: Pengguna lama sebelum update nama
        setupOldUserNeedsName(myCode);
      } else { // Pengguna baru
        setupNewUser();
      }
    }

    // --- FUNGSI PENDUKUNG ---

    function setupExistingUser(myCode, myName) {
      userNameInput.value = myName;
      userNameInput.disabled = true;
      codeInput.value = myCode;
      codeInput.disabled = true;
      nameStatus.textContent = `Nama Anda telah diatur.`;
      codeStatus.textContent = "ID Anda telah diatur.";
      resetBtn.style.display = 'block';
    }
    
    function setupOldUserNeedsName(myCode) {
        showPopup("Update: Silakan masukkan nama Anda untuk melanjutkan.");
        codeInput.value = myCode;
        codeInput.disabled = true; // ID lama tetap, tidak bisa diubah
        userNameInput.disabled = false;
        nameStatus.textContent = "Masukkan nama Anda, lalu tekan Enter.";
        
        userNameInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                const newName = userNameInput.value.trim();
                if (newName) {
                    const userRef = ref(db, `users/${myCode}`);
                    await update(userRef, { name: newName }); // Update nama di Firebase
                    localStorage.setItem('myName', newName);
                    showPopup("Nama berhasil diperbarui!");
                    setTimeout(() => location.reload(), 1500);
                }
            }
        });
    }
    
    function setupNewUser() {
        nameStatus.textContent = "1. Masukkan nama, lalu tekan Enter.";
        
        userNameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const newName = userNameInput.value.trim();
                if (newName) {
                    localStorage.setItem('myName', newName);
                    userNameInput.disabled = true;
                    codeInput.disabled = false;
                    nameStatus.textContent = `Nama disimpan: ${newName}`;
                    codeStatus.textContent = "2. Sekarang masukkan 6 digit ID Anda.";
                    codeInput.focus();
                }
            }
        });

        codeInput.addEventListener('input', handleNewCodeInput);
    }

    async function handleNewCodeInput(e) {
        const code = e.target.value.trim();
        if (!/^\d{6}$/.test(code)) {
            codeStatus.textContent = "ID harus terdiri dari 6 digit angka.";
            return;
        }

        const userRef = ref(db, `users/${code}`);
        const snap = await get(userRef);

        if (snap.exists()) {
            codeStatus.textContent = "ID ini sudah digunakan. Coba yang lain.";
        } else {
            const myName = localStorage.getItem('myName');
            await set(userRef, { name: myName, createdAt: Date.now() });
            localStorage.setItem('myCode', code);
            codeStatus.textContent = "ID berhasil disimpan!";
            codeInput.disabled = true;
            resetBtn.style.display = 'block';
            codeInput.removeEventListener('input', handleNewCodeInput);
        }
    }

    function listenForPartner(myCode) {
        const connRef = ref(db, `connections/${myCode}/partner`);
        onValue(connRef, async (snap) => {
            const partnerCode = snap.val();
            if (partnerCode) {
                const partnerUserRef = ref(db, `users/${partnerCode}`);
                const partnerSnap = await get(partnerUserRef);
                const partnerName = partnerSnap.exists() ? partnerSnap.val().name : "Partner";
                
                showPopup(`Anda kini tersambung dengan: ${partnerName} (${partnerCode})`);
                accompliceInput.value = `${partnerName} (${partnerCode})`;
                localStorage.setItem('accompliceCode', partnerCode);
                disconnectBtn.style.display = 'block';
            } else {
                accompliceInput.value = '';
                localStorage.removeItem('accompliceCode');
                disconnectBtn.style.display = 'none';
            }
        });
    }

    async function clearAllData() {
        const myCode = localStorage.getItem('myCode');
        const accompliceCode = localStorage.getItem('accompliceCode');
        try {
            if (myCode) {
                if (accompliceCode) { await remove(ref(db, `connections/${accompliceCode}`)); }
                await remove(ref(db, `users/${myCode}`));
                await remove(ref(db, `connections/${myCode}`));
            }
        } finally {
            localStorage.removeItem('myCode');
            localStorage.removeItem('myName'); // PERBAIKAN: Hapus nama juga
            localStorage.removeItem('accompliceCode');
        }
    }

    // --- EVENT LISTENERS ---

    linkBtn.addEventListener('click', async () => {
      const myCode = localStorage.getItem('myCode');
      const accompliceCode = accompliceInput.value.trim();

      if (!myCode) { showPopup('Anda harus mengatur identitas Anda terlebih dahulu!'); return; }
      // ... (sisa logika sama)
      
      const accompliceUserRef = ref(db, `users/${accompliceCode}`);
      const snap = await get(accompliceUserRef);
      if (!snap.exists()) { showPopup(`ID partner ${accompliceCode} tidak ditemukan.`); return; }

      // ... (sisa logika sama)
      
      await set(ref(db, `connections/${accompliceCode}/requestFrom`), myCode);
      showPopup(`Permintaan koneksi terkirim ke ${accompliceCode}.`);
    });

    disconnectBtn.addEventListener('click', async () => {
        const myCode = localStorage.getItem('myCode');
        if (!myCode) return;

        if (confirm(`Anda yakin ingin memutuskan sambungan?`)) {
            const accompliceCode = localStorage.getItem('accompliceCode');
            if(accompliceCode) {
                await remove(ref(db, `connections/${myCode}`));
                await remove(ref(db, `connections/${accompliceCode}`));
            }
        }
    });
    
    resetBtn.addEventListener('click', async () => { 
        if (confirm("Anda yakin ingin mengganti identitas? Ini akan memutuskan koneksi yang ada.")) { 
            await clearAllData(); 
            location.reload(); 
        } 
    });
    
    clearDataBtn.onclick = async () => {
        if (confirm("TINDAKAN PERMANEN! Ini akan menghapus semua jejak Anda. Lanjutkan?")) {
            await clearAllData();
            showPopup("Semua jejak telah dihapus.");
            setTimeout(() => location.reload(), 1500);
        }
    };

    // (event listener untuk custom preset tetap sama)
    const savePresetBtn = document.getElementById('savePresetBtn');
    const clearPresetBtn = document.getElementById('clearPresetBtn');
    const customPresetInput = document.getElementById('customPresetInput');

    savePresetBtn.addEventListener('click', () => {
        const presets = customPresetInput.value.trim().split(',').map(p => p.trim()).filter(Boolean);
        if(presets.length > 0) {
            localStorage.setItem('customPresets', JSON.stringify(presets));
            showPopup('Preset disimpan!');
        }
    });

    clearPresetBtn.addEventListener('click', () => {
        localStorage.removeItem('customPresets');
        customPresetInput.value = '';
        showPopup('Preset dihapus!');
    });

    customPresetInput.value = JSON.parse(localStorage.getItem('customPresets') || '[]').join(', ');
    
    // --- Inisialisasi Halaman ---
    initializePage();
  </script>
</body>
</html>
