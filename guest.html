<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#000000">
  <title>Obscura - Guest Sender</title>
  <link href="https://fonts.googleapis.com/css2?family=Cardo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: 'Cardo', serif;
      background: radial-gradient(ellipse at center, #111 0%, #000 100%);
      color: #e0e0e0;
    }
    .status-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
    }
    .scroll-container {
      height: 100%;
      overflow-y: auto;
      padding: 24px;
      transition: opacity 0.5s ease-in-out;
    }
    .hidden {
      opacity: 0;
      pointer-events: none;
      position: absolute;
    }
    .status-message {
      font-size: 1.2em;
      color: #aaa;
    }
    section {
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 20px 0;
      margin-bottom: 20px;
    }
    h2 {
      font-size: 18px;
      color: #aaa;
      margin: 0 0 15px 0;
      font-weight: 400;
    }
    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: #eee;
      text-align: center;
    }
    .numpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .numpad button, .calc-keys button {
      font-size: 20px;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      color: #eee;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .numpad button:hover, .calc-keys button:hover {
        background-color: rgba(255,255,255,0.1);
    }
    .calc {
      margin-top: 12px;
    }
    .calc-display {
      background: rgba(0,0,0,0.2);
      padding: 16px;
      border-radius: 8px;
      font-size: 24px;
      margin-bottom: 12px;
      min-height: 32px;
      text-align: right;
      word-wrap: break-word;
    }
    .calc-keys {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
  </style>
</head>
<body>

  <div id="mainContainer" class="scroll-container hidden">
    <section>
      <h2>Input Teks</h2>
      <input type="text" id="textInput" placeholder="Ketik lalu tekan Enter" />
    </section>

    <section>
      <h2>Input Angka Cepat</h2>
      <div class="numpad" id="numpad"></div>
    </section>

    <section>
      <h2>Kalkulator</h2>
      <div class="calc">
        <div class="calc-display" id="calcDisplay"></div>
        <div class="calc-keys" id="calcKeys"></div>
      </div>
    </section>
  </div>

  <div id="statusContainer" class="status-container">
    <p id="statusMessage" class="status-message">Menghubungkan...</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, set, remove, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDagbp2KWMuueh-ZmFZQ-nSAnRcummUgkM",
      authDomain: "obscurabyheri.firebaseapp.com",
      databaseURL: "https://obscurabyheri-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "obscurabyheri",
      storageBucket: "obscurabyheri.appspot.com",
      messagingSenderId: "866868400960",
      appId: "1:866868400960:web:440e1b4979a1c0cf8a20a5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const mainContainer = document.getElementById('mainContainer');
    const statusContainer = document.getElementById('statusContainer');
    const statusMessage = document.getElementById('statusMessage');
    const textInput = document.getElementById("textInput");
    const numpad = document.getElementById("numpad");
    const calcDisplay = document.getElementById("calcDisplay");
    const calcKeys = document.getElementById("calcKeys");

    let hostId = null;

    // --- PERUBAHAN 1: Menambahkan data urutan kartu Mnemonica ---
    const mnemonicaStack = [
      "4 Sekop", "2 Hati", "7 Keriting", "3 Sekop", "4 Hati", "6 Keriting", "As Sekop", "5 Hati", "9 Sekop", "2 Keriting",
      "Ratu Hati", "3 Keriting", "Ratu Sekop", "5 Sekop", "7 Hati", "Jack Keriting", "As Hati", "8 Sekop", "6 Hati", "Jack Sekop",
      "5 Keriting", "King Hati", "10 Sekop", "3 Hati", "8 Keriting", "King Sekop", "3 Wajik", "Jack Hati", "9 Keriting", "King Keriting",
      "8 Hati", "10 Keriting", "King Wajik", "2 Sekop", "7 Wajik", "As Keriting", "9 Hati", "2 Wajik", "Jack Wajik", "4 Keriting",
      "6 Wajik", "8 Wajik", "4 Wajik", "As Wajik", "9 Wajik", "Ratu Keriting", "7 Sekop", "10 Wajik", "5 Wajik", "Ratu Wajik",
      "10 Hati", "6 Sekop"
    ];

    function goBlank(message) {
        mainContainer.classList.add('hidden');
        statusMessage.textContent = message;
        statusContainer.classList.remove('hidden');
    }

    async function initializeGuestSession() {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');

        if (!token) {
            goBlank("Link tidak valid.");
            return;
        }

        const tokenRef = ref(db, `guestTokens/${token}`);
        
        try {
            const snapshot = await get(tokenRef);
            if (!snapshot.exists()) {
                goBlank("Link sudah tidak berlaku atau salah.");
                return;
            }

            hostId = snapshot.val().hostId;
            
            await remove(tokenRef);

            const hostStatusRef = ref(db, `status/${hostId}`);
            onValue(hostStatusRef, (snap) => {
                if (!snap.exists()) {
                    goBlank("Koneksi dengan host terputus.");
                }
            });

            const guestPresenceRef = ref(db, `guestConnections/${hostId}`);
            await set(guestPresenceRef, { connectedAt: Date.now() });
            onDisconnect(guestPresenceRef).remove();

            statusContainer.classList.add('hidden');
            mainContainer.classList.remove('hidden');

        } catch (error) {
            console.error("Initialization error:", error);
            goBlank("Gagal terhubung ke server.");
        }
    }

    // Event listeners untuk mengirim data
    textInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && textInput.value.trim() && hostId) {
        set(ref(db, `data/${hostId}/text`), textInput.value.trim());
        textInput.value = "";
      }
    });

    [1,2,3,4,5,6,7,8,9,0].forEach(num => {
      const btn = document.createElement("button");
      btn.textContent = num;
      btn.onclick = () => {
        if (hostId) {
            set(ref(db, `data/${hostId}/number`), num);
        }
      };
      numpad.appendChild(btn);
    });

    let expression = "";
    const keys = ['7','8','9','/','4','5','6','*','1','2','3','-','0','.','=','+'];
    keys.forEach(key => {
      const btn = document.createElement("button");
      btn.textContent = key;
      btn.onclick = () => {
        if (hostId) {
            if (key === '=') {
              try {
                // --- PERUBAHAN 2: Logika baru untuk tombol "=" ---
                const num = parseInt(expression, 10);
                // Cek apakah input adalah angka tunggal antara 1 dan 52
                if (!isNaN(num) && String(num) === expression && num >= 1 && num <= 52) {
                    const cardName = mnemonicaStack[num - 1];
                    // Kirim nama kartu sebagai teks
                    set(ref(db, `data/${hostId}/text`), cardName);
                } else {
                    // Jika bukan, lakukan perhitungan matematika biasa
                    let result = new Function('return ' + expression)();
                    if (typeof result === 'number') {
                      result = Math.round(result * 1000) / 1000;
                    }
                    // Kirim hasil perhitungan sebagai teks
                    set(ref(db, `data/${hostId}/text`), String(result));
                }
                expression = "";
                calcDisplay.textContent = "";

              } catch {
                calcDisplay.textContent = 'Error';
                expression = "";
              }
            } else {
              expression += key;
              calcDisplay.textContent = expression;
            }
        }
      };
      calcKeys.appendChild(btn);
    });

    initializeGuestSession();
  </script>
</body>
</html>
